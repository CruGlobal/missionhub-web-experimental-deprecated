<div class="page-header" layout="row" layout-align="space-between">
  <h4>Timeline</h4>
  <div>
    <md-button class="md-accent md-button-sm md-button-header"
               ng-class="{'md-raised': timeline.visibleEventTypes.interaction}"
               ng-click="timeline.visibleEventTypes.interaction = !timeline.visibleEventTypes.interaction"
               ng-switch="timeline.visibleEventTypes.interaction"
               aria-label="Show/Hide">
      <ng-md-icon ng-switch-when="true" icon="visibility" size="10"></ng-md-icon>
      <ng-md-icon ng-switch-when="false" icon="visibility_off" size="10"></ng-md-icon>
      Interactions
    </md-button>
    <md-button class="md-accent md-button-sm md-button-header"
               ng-class="{'md-raised': timeline.visibleEventTypes.message}"
               ng-click="timeline.visibleEventTypes.message = !timeline.visibleEventTypes.message"
               ng-switch="timeline.visibleEventTypes.message"
               aria-label="Show/Hide">
      <ng-md-icon ng-switch-when="true" icon="visibility" size="10"></ng-md-icon>
      <ng-md-icon ng-switch-when="false" icon="visibility_off" size="10"></ng-md-icon>
      Messages
    </md-button>
    <md-button class="md-accent md-button-sm md-button-header"
               ng-class="{'md-raised': timeline.visibleEventTypes.survey}"
               ng-click="timeline.visibleEventTypes.survey = !timeline.visibleEventTypes.survey"
               ng-switch="timeline.visibleEventTypes.survey"
               aria-label="Show/Hide">
      <ng-md-icon ng-switch-when="true" icon="visibility" size="10"></ng-md-icon>
      <ng-md-icon ng-switch-when="false" icon="visibility_off" size="10"></ng-md-icon>
      Surveys
    </md-button>
  </div>
</div>
<md-card class="timeline-card actions-card">
  <div layout="row" layout-align="space-between center">
    <md-button class="md-accent">
      <ng-md-icon icon="people"></ng-md-icon>
      Add Interaction
    </md-button>
    <md-button class="md-accent">
      <ng-md-icon icon="send"></ng-md-icon>
      Send New Message
    </md-button>
    <md-button class="md-accent">
      <ng-md-icon icon="assignment"></ng-md-icon>
      Input Survey Answers
    </md-button>
  </div>
</md-card>
<md-card class="timeline-card" ng-repeat="event in filteredEvents = (timeline.events | eventType:timeline.visibleEventTypes | orderBy : '-timestamp')">
  <div class="timeline-header" layout="row" layout-align="start center">
    <div class="timeline-badge md-primary">
      <div class="badge-day">{{timeline.moment(event.timestamp).format('D')}}</div>
      <div class="badge-month">{{timeline.moment(event.timestamp).format('MMM')}}</div>
    </div>
    <h4 ng-switch="event.eventType" ng-if="!event.edit">
      <ng-md-icon ng-switch-when="interaction" icon="people"></ng-md-icon>
      <ng-md-icon ng-switch-when="message" icon="email"></ng-md-icon>
      <ng-md-icon ng-switch-when="survey" icon="assignment"></ng-md-icon>
      <span ng-switch-when="interaction" ng-switch="event.type">
        <span ng-switch-when="Comment Only">Comment</span>
        <span ng-switch-when="Spiritual Conversation">Spiritual Conversation</span>
        <span ng-switch-when="Personal Evangelism">Personal Evangelism</span>
        <span ng-switch-when="Personal Evangelism Decisions">Personal Evangelism Decisions</span>
        <span ng-switch-when="Holy Spirit Presentation">Holy Spirit Presentation</span>
        <span ng-switch-when="Graduating on Mission">Graduating on Mission</span>
        <span ng-switch-default>{{event.type}}</span>
      </span>
      <span ng-switch-when="message" ng-switch="event.sent_via">
        <span ng-switch-when="sms">SMS</span>
        <span ng-switch-when="email">Email</span>
        <span ng-switch-default>{{event.sent_via | capitalize}}</span>
      </span>
      <span ng-switch-when="survey">
        {{event.surveyType}}
      </span>
      <small>
        <span ng-switch-when="interaction">
          with
          <span ng-repeat-start="initiator in event.initiators" ng-if="$last && !$first"> and</pre></span>
          <span ng-repeat-end><a ui-sref="people.card({personId: initiator.id})">{{initiator.name}}</a>{{!$last && event.initiators.length > 2 ? ',' : ''}}</span>
        </span>
        <span ng-switch-when="message">
          from
          <a ui-sref="people.card({personId: event.sender.id})">{{event.sender.name}}</a>
        </span>
        <span ng-switch-when="survey">TODO: does this need/have a initiator?</span>
      </small>
    </h4>
    <div ng-if="event.edit" layout="row" layout-align="start center">
      <md-input-container class="remove-padding">
        <label>Type</label>
        <md-select ng-model="event.type">
          <md-option ng-value="type" ng-repeat="type in timeline.interactionTypes">{{type}}</md-option>
        </md-select>
      </md-input-container>
      <h4>
        <small>with {{event.initiator}}</small>
      </h4>
    </div>
    <span flex></span>
    <md-button class="md-icon-button" aria-label="Edit" ng-click="event.edit=true" ng-if="event.eventType === 'interaction' && !event.edit">
      <ng-md-icon icon="edit"></ng-md-icon>
    </md-button>
    <md-button class="md-icon-button" aria-label="Save" ng-click="event.edit=false" ng-if="event.edit">
      <ng-md-icon icon="save"></ng-md-icon>
    </md-button>
  </div>
  <md-card-content class="no-spacing-above" ng-switch="event.eventType">
    <p ng-if="!event.edit">
      <small class="text-muted">
        <i class="glyphicon glyphicon-time"></i>
        Created {{timeline.moment(event.created_at).fromNow()}}
        - Visible to everyone in {{event.organization.name}}
        <span ng-if="event.creator"> - Created by <a ui-sref="people.card({personId: event.creator.id})">{{event.creator.name}}</a></span>
      </small>
    </p>
    <div ng-if="event.edit">
      <md-datepicker ng-model="event.time"></md-datepicker>
    </div>
    <div ng-switch-when="interaction" ng-if="!event.edit">{{event.comment}}</div>
    <md-input-container ng-switch-when="interaction" ng-if="event.edit">
      <label>Comment</label>
      <textarea ng-model="event.comment"></textarea>
    </md-input-container>
    <div ng-switch-when="message">
      <md-card class="message-container md-whiteframe-1dp">
        <md-card-content>
          <div ng-if="event.to">
            <strong>To:</strong>
            <span ng-if="event.sent_via == 'email'">{{event.to}}</span>
            <span ng-if="event.sent_via == 'sms'">{{event.to | phone}}</span>
          </div>
          <div ng-if="event.from">
            <strong>From:</strong>
            {{event.from}}
          </div>
          <div ng-if="event.subject">
            <strong>Subject:</strong>
            {{event.subject}}
          </div>
        </md-card-content>
        <md-divider></md-divider>
        <md-card-content class="pre-message">{{event.message}}</md-card-content>
      </md-card>
    </div>
    <div ng-switch-when="survey">
      <dl class="dl-horizontal">
        <dt ng-repeat-start="surveyQuestion in event.survey">{{surveyQuestion.question}}</dt>
        <dd ng-repeat-end>{{surveyQuestion.answer}}</dd>
      </dl>
    </div>
  </md-card-content>
</md-card>
<md-card class="timeline-card" ng-if="filteredEvents.length === 0 && !timeline.loading">
  <md-card-content>
    <div class="text-center text-muted">
      <ng-md-icon icon="warning" size="40" style="width: 40px; height: 40px;"></ng-md-icon>
      <h3>There were no events found.</h3>

      <div ng-if="!timeline.visibleEventTypes.interaction || !timeline.visibleEventTypes.message || !timeline.visibleEventTypes.survey">
        Try showing more types:<br>
        <md-button ng-if="!timeline.visibleEventTypes.interaction"
                   class="md-accent md-button-sm md-button-header md-raised"
                   ng-click="timeline.visibleEventTypes.interaction = !timeline.visibleEventTypes.interaction">
          <ng-md-icon icon="visibility" size="10"></ng-md-icon>
          Show Interactions
        </md-button>
        <md-button ng-if="!timeline.visibleEventTypes.message"
                   class="md-accent md-button-sm md-button-header md-raised"
                   ng-click="timeline.visibleEventTypes.message = !timeline.visibleEventTypes.message"
                   ng-switch="timeline.visibleEventTypes.message"
                   aria-label="Show/Hide">
          <ng-md-icon icon="visibility" size="10"></ng-md-icon>
          Show Messages
        </md-button>
        <md-button ng-if="!timeline.visibleEventTypes.survey"
                   class="md-accent md-button-sm md-button-header md-raised"
                   ng-click="timeline.visibleEventTypes.survey = !timeline.visibleEventTypes.survey">
          <ng-md-icon icon="visibility" size="10"></ng-md-icon>
          Surveys
        </md-button>
      </div>
    </div>
  </md-card-content>
</md-card>
